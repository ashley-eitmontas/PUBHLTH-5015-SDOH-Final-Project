---
title: "Complied for Final"
output: html_document
date: "2025-12-06"
---
## Prepare Data Set

```{r}
# Load data set, which is SDOH from Ohio Department of Health

census <-read.csv("SDOH_Census_Tract.csv")

# Load libraries needed for analysis

library(ggplot2)
library(readr)
library(dplyr)
library(tidyr)
library(purrr)
library(broom)
library(stringr)


# Filter out non-Appalachian Ohio counties

exclude_nonapp <- c(
  "Allen","Ashland","Auglaize","Butler","Champaign",
  "Clark","Clinton","Crawford","Cuyahoga","Darke",
  "Defiance","Delaware","Erie","Fairfield","Fayette",
  "Franklin","Fulton","Geauga","Greene","Hamilton",
  "Hancock","Hardin","Henry","Huron","Knox",
  "Lake","Licking","Logan","Lorain","Lucas",
  "Madison","Marion","Medina","Mercer","Miami",
  "Montgomery","Morrow","Ottawa","Paulding","Pickaway",
  "Portage","Preble","Putnam","Richland","Sandusky",
  "Seneca","Shelby","Stark","Summit","Union",
  "Van Wert","Warren","Wayne","Williams","Wood",
  "Wyandot"
)

app_data <- census %>%
  filter(!(county_name %in% exclude_nonapp))


```

## County average asthma regression model - median household income

```{r}


# 1st step: filter out just the asthma rate and median household data for each county, and find the mean for each county.
app_asthma <- app_data %>%
  filter(metric_name == "Asthma Rate") %>%
  mutate(metric_value = as.numeric(gsub("%", "", metric_value))) %>%
  group_by(county_name) %>%
  summarise(mean_asthma = mean(metric_value, na.rm = TRUE))

app_income <- app_data %>%
  filter(metric_name == "Median Household Income") %>%
  mutate(
    metric_value = gsub("[^0-9.]", "", metric_value),  
    metric_value = ifelse(metric_value == "", NA, metric_value),
    metric_value = as.numeric(metric_value)
  ) %>%
  group_by(county_name) %>%
  summarise(mean_income = mean(metric_value, na.rm = TRUE), .groups = "drop")

# Combine the data, since in the excel sheet each metric is a separate data point
app_combined_asthma<- inner_join(app_income, app_asthma, by = "county_name")
app_combined_asthma

# Run the regression model using the combined data set
app_model_income <- lm(mean_income~ mean_asthma, data = app_combined_asthma)
summary(app_model_income)

#Plot the data
ggplot(app_combined_asthma, aes(x = mean_income, y = mean_asthma)) +
  geom_point(color = "darkgreen", size = 3, alpha = 0.7) +  
  geom_smooth(method = "lm", color = "red", se = TRUE) +    
  labs(
    title = "Asthma Rate vs Mean Income in App. Counties",
    x = "Mean Income ($)",
    y = "Mean Asthma Rate (%)"
  ) +
  theme_minimal(base_size = 14)
```

## Compare the Appalachian county regression with all Ohio counties 

```{r}
asthma <- census %>%
  filter(metric_name == "Asthma Rate") %>%
  mutate(metric_value = as.numeric(gsub("%", "", metric_value))) %>%
  group_by(county_name) %>%
  summarise(mean_asthma = mean(metric_value, na.rm = TRUE))

income <- census %>%
  filter(metric_name == "Median Household Income") %>%
  mutate(
    metric_value = gsub("[^0-9.]", "", metric_value),  
    metric_value = ifelse(metric_value == "", NA, metric_value),
    metric_value = as.numeric(metric_value)
  ) %>%
  group_by(county_name) %>%
  summarise(mean_income = mean(metric_value, na.rm = TRUE), .groups = "drop")


combined_asthma<- inner_join(income, asthma, by = "county_name")
combined_asthma

combined_asthma <- combined_asthma %>%
  mutate(highlight = ifelse(county_name %in% c(  "Adams", "Athens", "Belmont", "Brown", "Carroll", 
  "Clermont", "Coshocton", "Gallia", "Guernsey", "Harrison",
  "Hocking", "Jackson", "Jefferson", "Lawrence", "Meigs",
  "Monroe", "Morgan", "Muskingum", "Noble", "Perry",
  "Pike", "Ross", "Scioto", "Vinton", "Washington"), "Appalachian Counties", "Other"))

asthma_model_all_income <- lm(mean_income~ mean_asthma, data = combined_asthma)
summary(asthma_model_all_income)

ggplot(combined_asthma, aes(x = mean_income, y = mean_asthma, color = highlight)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_smooth(method = "lm", color = "red", se = TRUE) +
  scale_color_manual(values = c("Other" = "steelblue", "Appalachian Counties" = "darkgreen")) +
  labs(
    title = "Asthma Rate vs Mean Income in Ohio Counties",
    x = "Mean Income ($)",
    y = "Mean Asthma Rate (%)",
    color = "County Type"
  ) +
  theme_minimal(base_size = 14)

```

## Repeat this county average metric regressions for the other 4 selected metrics

### Poverty Rate - County Average

```{r}
# filter out poverty rate data
app_poverty <- app_data %>%
  filter(metric_name == "Poverty Rate") %>%
  mutate(
    metric_value = gsub("[^0-9.]", "", metric_value),  
    metric_value = ifelse(metric_value == "", NA, metric_value),
    metric_value = as.numeric(metric_value)
  ) %>%
  group_by(county_name) %>%
  summarise(mean_poverty = mean(metric_value, na.rm = TRUE), .groups = "drop")
# combine poverty rate and asthma rate
app_combined_asthma_poverty<- inner_join(app_poverty, app_asthma, by = "county_name")
app_combined_asthma_poverty
# run linear regression for poverty rate and asthma rate
app_model_poverty <- lm(mean_poverty~ mean_asthma, data = app_combined_asthma_poverty)
summary(app_model_poverty)
# plot the regression
ggplot(app_combined_asthma_poverty, aes(x = mean_poverty, y = mean_asthma)) +
  geom_point(color = "darkgreen", size = 3, alpha = 0.7) +  
  geom_smooth(method = "lm", color = "red", se = TRUE) +    
  labs(
    title = "Asthma Rate vs Poverty in App. Counties",
    x = "Mean Poverty ($)",
    y = "Mean Asthma Rate (%)"
  ) +
  theme_minimal(base_size = 14)

```

### Uninsured Rate - County Average

```{r}
app_uninsured <- app_data %>%
  filter(metric_name == "Uninsured Rate") %>%
  mutate(
    metric_value = gsub("[^0-9.]", "", metric_value),  
    metric_value = ifelse(metric_value == "", NA, metric_value),
    metric_value = as.numeric(metric_value)
  ) %>%
  group_by(county_name) %>%
  summarise(mean_uninsured = mean(metric_value, na.rm = TRUE), .groups = "drop")

asthma_uninsured <- inner_join(app_uninsured, app_asthma, by = "county_name")
asthma_uninsured
model_uninsured <- lm(mean_uninsured ~ mean_asthma, data = asthma_uninsured)
summary(model_uninsured)

ggplot(asthma_uninsured, aes(x = mean_uninsured, y = mean_asthma)) +
  geom_point(color = "darkgreen", size = 3, alpha = 0.7) +  
  geom_smooth(method = "lm", color = "red", se = TRUE) +    
  labs(
    title = "Asthma Rate vs Mean Uninsured Rate in App. Counties",
    x = "Mean Uninsured Rate (%)",
    y = "Mean Asthma Rate (%)"
  ) +
  theme_minimal(base_size = 14)

# Remove outlier (Holmes County)

asthma_uninsured_clean <- asthma_uninsured %>%
  filter(county_name != "Holmes")

model_uninsured_clean <- lm(mean_uninsured ~ mean_asthma, data = asthma_uninsured_clean)
summary(model_uninsured_clean)

ggplot(asthma_uninsured_clean, aes(x = mean_uninsured, y = mean_asthma)) +
  geom_point(color = "darkgreen", size = 3, alpha = 0.7) +  
  geom_smooth(method = "lm", color = "red", se = TRUE) +    
  labs(
    title = "Asthma Rate vs Mean Uninsured Rate in App. Counties w/o outlier",
    x = "Mean Uninsured Rate (%)",
    y = "Mean Asthma Rate (%)"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(size = 16, margin = margin(b = 10)),
    plot.margin = margin(t = 20, r = 10, b = 10, l = 10)
  )

```

### Unemployed Rate - County Average

```{r}
app_unemployed <- app_data %>%
  filter(metric_name == "Unemployment Rate") %>%
  mutate(
    metric_value = gsub("[^0-9.]", "", metric_value),  
    metric_value = ifelse(metric_value == "", NA, metric_value),
    metric_value = as.numeric(metric_value)
  ) %>%
  group_by(county_name) %>%
  summarise(mean_unemployed = mean(metric_value, na.rm = TRUE), .groups = "drop")
asthma_unemployed <- inner_join(app_unemployed, app_asthma, by = "county_name")
asthma_unemployed

unemployed_model <- lm(mean_unemployed ~ mean_asthma, data = asthma_unemployed)
summary(unemployed_model)
ggplot(asthma_unemployed, aes(x = mean_unemployed, y = mean_asthma)) +
  geom_point(color = "darkgreen", size = 3, alpha = 0.7) +  
  geom_smooth(method = "lm", color = "red", se = TRUE) +    
  labs(
    title = "Asthma Rate vs Mean Unemployment Rate in App. Counties",
    x = "Mean Unemployment Rate (%)",
    y = "Mean Asthma Rate (%)"
  ) +
  theme_minimal(base_size = 14)
```


### 25 or Older with Less than a HS Degree - County Average
```{r}
app_education <- app_data %>%
  filter(metric_name == "25 or Older With Less Than HS Degree Rate") %>%
  mutate(
    metric_value = gsub("[^0-9.]", "", metric_value),  
    metric_value = ifelse(metric_value == "", NA, metric_value),
    metric_value = as.numeric(metric_value)
  ) %>%
  group_by(county_name) %>%
  summarise(mean_education = mean(metric_value, na.rm = TRUE), .groups = "drop")
education_asthma <- inner_join(app_education, app_asthma, by = "county_name")
education_asthma
education_model <- lm(mean_education ~ mean_asthma, data = education_asthma)
summary(education_model)
ggplot(education_asthma, aes(x = mean_education, y = mean_asthma)) +
  geom_point(color = "darkgreen", size = 3, alpha = 0.7) +  
  geom_smooth(method = "lm", color = "red", se = TRUE) +    
  labs(
    title = "Asthma Rate vs Education Level in App. Counties",
    x = "Mean % 25+ With < HS Degree",
    y = "Mean Asthma Rate (%)"
  ) +
  theme_minimal(base_size = 14)
```


## Regressions for Each Metric for Each County using geo_ID
### Test one county to establish formula

```{r}
# filter data
app_data <- app_data %>%
  filter(metric_name %in% c(
    "Asthma Rate",
    "Median Household Income",
    "Poverty Rate",
    "25 or Older With Less Than HS Degree Rate",
    "Uninsured Rate",
    "Unemployment Rate"
  )) %>%
  mutate(
    metric_value = gsub("[%,\\$]", "", metric_value),
    metric_value = ifelse(metric_value == "", NA, metric_value),  
    metric_value = as.numeric(metric_value)                       
  )
app_data <- app_data %>% filter(!is.na(metric_value))

head(app_data)
# Choose one county (Lawrence)
lawrence <- app_data %>%
  filter(county_name == "Lawrence")
lawrence <- lawrence %>%
  filter(metric_name %in% c("Asthma Rate" , "Median Household Income", "Poverty Rate" , "25 or Older With Less Than HS Degree Rate", "Uninsured Rate", "Unemployment Rate"))
lawrence <- lawrence %>%
  filter(county_name == "Lawrence") %>%   
  mutate(
    metric_value = gsub("[%,\\$]", "", metric_value),
    metric_value = as.numeric(metric_value)
  ) %>%
  select(geo_id, metric_name, metric_value) %>%
  tidyr::pivot_wider(
    names_from = metric_name,
    values_from = metric_value
  )
# Run a regression for each metric in Lawrence
predictors <- c("Poverty Rate", "Median Household Income",
                "25 or Older With Less Than HS Degree Rate",
                "Uninsured Rate", "Unemployment Rate")
lawrence_long <- lawrence %>%
  pivot_longer(cols = all_of(predictors), 
               names_to = "metric", values_to = "value")
lawrence_models <- lawrence_long %>%
  group_by(metric) %>%
  do(model = lm(`Asthma Rate` ~ value, data = .))

names(lawrence_models) <- unique(lawrence_long$metric)
lawrence_models

ggplot(lawrence_long, aes(x = value, y = `Asthma Rate`)) +
  geom_point(color = "darkgreen") +
  geom_smooth(method = "lm", se = TRUE, color = "blue") +
  facet_wrap(~ metric, scales = "free_x") +  # one plot per metric
  labs(title = "Lawrence County Asthma Rate vs Each Metric",
       x = "Metric Value",
       y = "Asthma Rate") +
  theme_minimal()
```


### Repeat this formula for the regressions for each county
```{r}
# Define predictors
predictors <- c(
  "Poverty Rate",
  "Median Household Income",
  "25 or Older With Less Than HS Degree Rate",
  "Uninsured Rate",
  "Unemployment Rate"
)

# Make sure the data set is able to be used
clean_data <- app_data %>%
  filter(metric_name %in% c("Asthma Rate", predictors)) %>%
  mutate(
    metric_value = gsub("[%,\\$]", "", metric_value),
    metric_value = as.numeric(metric_value)
  ) %>%
  select(county_name, geo_id, metric_name, metric_value) %>%
  pivot_wider(
    names_from = metric_name,
    values_from = metric_value
  )
county_long <- clean_data %>%
  pivot_longer(
    cols = all_of(predictors),
    names_to = "metric",
    values_to = "value"
  )

# Run regressions
county_models <- county_long %>%
  group_by(county_name, metric) %>%
  group_map(~ lm(`Asthma Rate` ~ value, data = .x))

names(county_models) <- county_long %>%
  group_by(county_name, metric) %>%
  group_keys() %>%
  mutate(name = paste(county_name, metric, sep = " - ")) %>%
  pull(name)

# Get model results and determine significance
model_results <- map_df(
  names(county_models),
  function(name) {
    broom::tidy(county_models[[name]]) %>%
      filter(term == "value") %>%    # the slope
      mutate(
        county_name = sub(" - .*", "", name),
        metric = sub(".* - ", "", name)
      )
  }
) %>%
  mutate(significant = ifelse(p.value < 0.05, "Significant", "Not Significant"))

# Assign results
model_results <- model_results %>%
  mutate(
    county_name = factor(county_name, levels = sort(unique(county_name))),
    metric = factor(metric, levels = predictors)
  )

# Create the heatmap and refine its appearance


model_results <- model_results %>%
  mutate(metric_wrapped = str_wrap(metric, width = 15))  # adjust width as needed

n_counties <- length(unique(model_results$county_name))

ggplot(model_results, aes(x = metric_wrapped, y = county_name, fill = significant)) +
  geom_tile(color = "white", width = 0.9, height = 1.2) +  # taller and slightly fatter tiles
  scale_fill_manual(values = c("Significant" = "blue", "Not Significant" = "#d3d3d3")) +
  labs(
    title = "Significant Predictors of Asthma Rate by County",
    x = "Predictor",
    y = "County",
    fill = "Significant"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5, size = 16),
    axis.text.x = element_text(angle = 0, hjust = 0.5, size = 10),  # no rotation needed now
    axis.text.y = element_text(size = 10),
    axis.title = element_text(size = 13),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    panel.grid = element_blank()
  )



```


## Pull Individual County Data for Select Counties (cont.)
### Meigs
```{r}
meigs <- app_data %>%
  filter(county_name == "Meigs")
meigs <- meigs %>%
  filter(metric_name %in% c("Asthma Rate" , "Median Household Income", "Poverty Rate" , "25 or Older With Less Than HS Degree Rate", "Uninsured Rate", "Unemployment Rate"))
meigs <- meigs %>%
  filter(county_name == "Meigs") %>%   
  mutate(
    metric_value = gsub("[%,\\$]", "", metric_value),
    metric_value = as.numeric(metric_value)
  ) %>%
  select(geo_id, metric_name, metric_value) %>%
  tidyr::pivot_wider(
    names_from = metric_name,
    values_from = metric_value
  )
predictors <- c("Poverty Rate", "Median Household Income",
                "25 or Older With Less Than HS Degree Rate",
                "Uninsured Rate", "Unemployment Rate")
meigs_long <- meigs %>%
  pivot_longer(cols = all_of(predictors), 
               names_to = "metric", values_to = "value")
meigs_models <- meigs_long %>%
  group_by(metric) %>%
  do(model = lm(`Asthma Rate` ~ value, data = .))
meigs_models <- meigs_long %>%
  group_by(metric) %>%
  group_map(~ lm(`Asthma Rate` ~ value, data = .x), .keep = TRUE)
names(meigs_models) <- unique(meigs_long$metric)
meigs_models
ggplot(meigs_long, aes(x = value, y = `Asthma Rate`)) +
  geom_point(color = "darkgreen") +
  geom_smooth(method = "lm", se = TRUE, color = "blue") +
  facet_wrap(
    ~ metric,
    scales = "free_x",
    labeller = label_wrap_gen(width = 15)   # <-- wraps long names
  ) +
  labs(
    title = "Meigs County Asthma Rate vs Each Metric",
    x = "Metric Value",
    y = "Asthma Rate"
  ) +
  theme_minimal() +
  theme(strip.text = element_text(size = 10))   # optional, makes text fit
names(meigs_models) <- meigs_long %>%
  group_by(metric) %>%
  group_keys() %>%
  pull(metric)
meigs_results <- map_df(
  names(meigs_models),
  function(metric_name) {
    broom::tidy(meigs_models[[metric_name]]) %>%
      filter(term == "value") %>%  # get only the predictor slope
      mutate(metric = metric_name)
  }
)
meigs_results
```
### Muskingum
```{r}

muskingum <- app_data %>%
  filter(county_name == "Muskingum")
meuskingum <- muskingum %>%
  filter(metric_name %in% c("Asthma Rate" , "Median Household Income", "Poverty Rate" , "25 or Older With Less Than HS Degree Rate", "Uninsured Rate", "Unemployment Rate"))
muskingum <- muskingum %>%
  filter(county_name == "Muskingum") %>%   
  mutate(
    metric_value = gsub("[%,\\$]", "", metric_value),
    metric_value = as.numeric(metric_value)
  ) %>%
  select(geo_id, metric_name, metric_value) %>%
  tidyr::pivot_wider(
    names_from = metric_name,
    values_from = metric_value
  )
predictors <- c("Poverty Rate", "Median Household Income",
                "25 or Older With Less Than HS Degree Rate",
                "Uninsured Rate", "Unemployment Rate")
muskingum_long <- muskingum %>%
  pivot_longer(cols = all_of(predictors), 
               names_to = "metric", values_to = "value")
muskingum_models <- muskingum_long %>%
  group_by(metric) %>%
  do(model = lm(`Asthma Rate` ~ value, data = .))
muskingum_models <- muskingum_long %>%
  group_by(metric) %>%
  group_map(~ lm(`Asthma Rate` ~ value, data = .x), .keep = TRUE)
names(muskingum_models) <- unique(muskingum_long$metric)
meigs_models
ggplot(muskingum_long, aes(x = value, y = `Asthma Rate`)) +
  geom_point(color = "darkgreen") +
  geom_smooth(method = "lm", se = TRUE, color = "blue") +
  facet_wrap(
    ~ metric,
    scales = "free_x",
    labeller = label_wrap_gen(width = 15)   # <-- wraps long names
  ) +
  labs(
    title = "Muskingum County Asthma Rate vs Each Metric",
    x = "Metric Value",
    y = "Asthma Rate"
  ) +
  theme_minimal() +
  theme(strip.text = element_text(size = 10))   # optional, makes text fit
names(muskingum_models) <- muskingum_long %>%
  group_by(metric) %>%
  group_keys() %>%
  pull(metric)
muskingum_results <- map_df(
  names(muskingum_models),
  function(metric_name) {
    broom::tidy(muskingum_models[[metric_name]]) %>%
      filter(term == "value") %>%  # get only the predictor slope
      mutate(metric = metric_name)
  }
)
muskingum_results

```
### Scioto
```{r}
scioto <- app_data %>%
  filter(county_name == "Scioto")
scioto <- scioto %>%
  filter(metric_name %in% c(
    "Asthma Rate", 
    "Median Household Income", 
    "Poverty Rate", 
    "25 or Older With Less Than HS Degree Rate", 
    "Uninsured Rate", 
    "Unemployment Rate"
  ))
scioto <- scioto %>%
  mutate(
    metric_value = gsub("[%,\\$]", "", metric_value),
    metric_value = as.numeric(metric_value)
  ) %>%
  select(geo_id, metric_name, metric_value) %>%
  tidyr::pivot_wider(names_from = metric_name, values_from = metric_value)
predictors <- c(
  "Poverty Rate", 
  "Median Household Income",
  "25 or Older With Less Than HS Degree Rate",
  "Uninsured Rate", 
  "Unemployment Rate"
)
scioto_long <- scioto %>%
  pivot_longer(cols = all_of(predictors), 
               names_to = "metric", values_to = "value")
scioto_models <- scioto_long %>%
  group_by(metric) %>%
  group_map(~ lm(`Asthma Rate` ~ value, data = .x), .keep = TRUE)
names(scioto_models) <- unique(scioto_long$metric)
ggplot(scioto_long, aes(x = value, y = `Asthma Rate`)) +
  geom_point(color = "darkgreen") +
  geom_smooth(method = "lm", se = TRUE, color = "blue") +
  facet_wrap(
    ~ metric,
    scales = "free_x",
    labeller = label_wrap_gen(width = 15)
  ) +
  labs(
    title = "Scioto County Asthma Rate vs Each Metric",
    x = "Metric Value",
    y = "Asthma Rate"
  ) +
  theme_minimal() +
  theme(strip.text = element_text(size = 10)) 
scioto_results <- map_df(
  names(scioto_models),
  function(metric_name) {
    broom::tidy(scioto_models[[metric_name]]) %>%
      filter(term == "value") %>%
      mutate(metric = metric_name)
  }
)
scioto_results

```

### Tuscarawas

```{r}
tuscarawas <- app_data %>%
  filter(county_name == "Tuscarawas")
tuscarawas <- tuscarawas %>%
  filter(metric_name %in% c(
    "Asthma Rate", 
    "Median Household Income", 
    "Poverty Rate", 
    "25 or Older With Less Than HS Degree Rate", 
    "Uninsured Rate", 
    "Unemployment Rate"
  ))
tuscarawas <- tuscarawas %>%
  mutate(
    metric_value = gsub("[%,\\$]", "", metric_value),
    metric_value = as.numeric(metric_value)
  ) %>%
  select(geo_id, metric_name, metric_value) %>%
  tidyr::pivot_wider(names_from = metric_name, values_from = metric_value)
predictors <- c(
  "Poverty Rate", 
  "Median Household Income",
  "25 or Older With Less Than HS Degree Rate",
  "Uninsured Rate", 
  "Unemployment Rate"
)
tuscarawas_long <- tuscarawas %>%
  pivot_longer(cols = all_of(predictors), 
               names_to = "metric", values_to = "value")      
tuscarawas_models <- tuscarawas_long %>%
  group_by(metric) %>%
  group_map(~ lm(`Asthma Rate` ~ value, data = .x), .keep = TRUE)
names(tuscarawas_models) <- unique(tuscarawas_long$metric)
ggplot(tuscarawas_long, aes(x = value, y = `Asthma Rate`)) +
  geom_point(color = "darkgreen") +
  geom_smooth(method = "lm", se = TRUE, color = "blue") +
  facet_wrap(
    ~ metric,
    scales = "free_x",
    labeller = label_wrap_gen(width = 15)
  ) +
  labs(
    title = "Tuscarawas County Asthma Rate vs Each Metric",
    x = "Metric Value",
    y = "Asthma Rate"
  ) +
  theme_minimal() +
  theme(strip.text = element_text(size = 10))
tuscarawas_results <- map_df(
  names(tuscarawas_models),
  function(metric_name) {
    broom::tidy(tuscarawas_models[[metric_name]]) %>%
      filter(term == "value") %>%
      mutate(metric = metric_name)
  }
)
tuscarawas_results
```